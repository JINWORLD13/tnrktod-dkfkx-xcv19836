---
config:
  layout: elk
  theme: base
  themeVariables:
    background: '#ffffff'
    primaryColor: '#ffffff'
---
flowchart TB
    %% User Layer
    subgraph UserLayer ["ðŸ‘¥ User Layer"]
        User["ðŸ‘¤ User"]
        Browser["ðŸŒ Web Browser"]
    end

    %% Frontend Layer
    subgraph Frontend ["ðŸ’» Frontend (React)"]
        %% Page Layer
        MyPage["ðŸ‘¤ My Page"]
        TarotPrinciple["ðŸ“– Tarot Principle"]
        HomePage["ðŸ  Home Page"]
        ETC["ðŸ“– ETC"]
        
        %% Component Layer  
        TarotModal["ðŸ”® Tarot Modal"]
        AnswerModal["ðŸ“– Answer Modal"]
        PurchaseModal["ðŸ›’ Purchase Modal"]
        ThreeScene["ðŸŽ® 3D Scene"]
        
        %% State Management
        Redux["âš¡ Redux Store"]
        LocalStorage["ðŸ’¾ Local Storage"]
        Cookie["ðŸ’¾ Cookie"]
        CapacitorPreference["ðŸ’¾ Capacitor Preference"]
    end

    %% Authentication Layer
    subgraph AuthLayer ["ðŸ” Authentication Layer"]
        AuthFlow["ðŸ” Google OAuth + JWT"]
    end

    %% API Layer
    subgraph APILayer ["ðŸŒ API Layer"]
        APIGateway["ðŸ“¡ Express.js Router + Google OAuth + JWT"]
    end

    %% Backend Service Layer
    subgraph Backend ["ðŸ–¥ï¸ Backend Services (Node.js)"]
        %% Controller Layer
        TarotController["ðŸ”® Tarot Controller"]
        UserController["ðŸ‘¤ User Controller"]
        ChargeController["ðŸ’³ Charge Controller"]
        
        %% Service Layer
        TarotService["ðŸ”® Tarot Service"]
        UserService["ðŸ‘¤ User Service"]
        ChargeService["ðŸ’³ Charge Service"]
        
        %% DAO Layer
        TarotDAO["ðŸ”® Tarot DAO"]
        UserDAO["ðŸ‘¤ User DAO"]
        ChargeDAO["ðŸ’³ Charge DAO"]
    end

    %% AI Service Layer
    subgraph AILayer ["ðŸ¤– AI Service Layer"]
        AIInterpreter["ðŸ§  AI Interpreter"]
        OpenAI["ðŸ’¡ OpenAI GPT"]
        SystemPrompt["âš™ï¸ System Prompt"]
        UserPrompt["ðŸ‘¤ User Prompt"]
        ResponseFormat["ðŸ“‹ Response Format"]
    end

    %% Data Layer
    subgraph DataLayer ["ðŸ’¾ Data Layer"]
        MongoDB[("ðŸƒ MongoDB")]
        Redis[("âš¡ Redis Cache")]
        UserCollection["ðŸ‘¤ Users"]
        TarotCollection["ðŸ”® Tarots"]
        ChargeCollection["ðŸ’³ Charges"]
        CounterCollection["ðŸ“Š Counters"]
    end

    %% External Services
    subgraph ExternalLayer ["ðŸŒ External Services"]
        GoogleAuth["ðŸ” Google OAuth"]
        TossPayments["ðŸ’³ Toss Payments"]
        InAppPurchase["ðŸ“± In-App Purchase"]
        GooglePlayConsole["ðŸŽ® Google Play Console"]
    end

    %% Connections
    User --> Browser
    Browser --> HomePage
    Browser --> TarotPrinciple
    Browser --> ETC
    
    %% MyPage ì¸ì¦ í”Œë¡œìš°
    Browser --> AuthFlow
    AuthFlow --> MyPage
    
    HomePage --> ThreeScene
    
    %% 3D Scene -> Tarot Modal ì¸ì¦ í”Œë¡œìš°
    ThreeScene --> AuthFlow
    AuthFlow --> TarotModal
    
    TarotModal --> AnswerModal
    TarotModal --> PurchaseModal
    MyPage --> AnswerModal
    MyPage --> PurchaseModal
    
    TarotModal --> Cookie
    TarotModal --> CapacitorPreference
    Cookie --> APIGateway
    CapacitorPreference --> APIGateway
    PurchaseModal --> APIGateway
    
    %% í†µí•©ëœ ì¸ì¦ í”Œë¡œìš°
    AuthFlow --> AuthRouter
    AuthRouter --> GoogleAuth
    GoogleAuth --> MongoDB
    AuthFlow --> APIGateway
    
    APIGateway --> TarotController
    APIGateway --> UserController
    APIGateway --> ChargeController
    
    TarotController --> TarotService
    TarotController --> UserService
    UserController --> UserService
    ChargeController --> ChargeService
    ChargeController --> UserService
    
    TarotService --> AIInterpreter
    TarotService --> TarotDAO
    TarotService --> Redis
    UserService --> UserDAO
    UserService --> Redis
    ChargeService --> ChargeDAO
    ChargeService --> TossPayments
    ChargeService --> InAppPurchase
    
    AIInterpreter --> SystemPrompt
    AIInterpreter --> UserPrompt
    AIInterpreter --> ResponseFormat
    AIInterpreter --> OpenAI
    
    TarotDAO --> MongoDB
    UserDAO --> MongoDB
    ChargeDAO --> MongoDB
    
    MongoDB --> UserCollection
    MongoDB --> TarotCollection
    MongoDB --> ChargeCollection
    MongoDB --> CounterCollection
    
    InAppPurchase --> GooglePlayConsole

    %% Styling Classes
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef frontendClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef authClass fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000
    classDef backendClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef aiClass fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef dataClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    classDef externalClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px,color:#000
    classDef layerClass fill:#f5f5f5,stroke:#666,stroke-width:2px,color:#000

    %% Apply Classes
    class User,Browser userClass
    class MyPage,HomePage,TarotPrinciple,ETC,TarotModal,AnswerModal,PurchaseModal,ThreeScene,Redux,LocalStorage,Cookie,CapacitorPreference frontendClass
    class AuthFlow authClass
    class APIGateway,TarotController,UserController,ChargeController,TarotService,UserService,ChargeService,TarotDAO,UserDAO,ChargeDAO backendClass
    class AIInterpreter,OpenAI,SystemPrompt,UserPrompt,ResponseFormat aiClass
    class MongoDB,Redis,UserCollection,TarotCollection,ChargeCollection,CounterCollection dataClass
    class GoogleAuth,TossPayments,InAppPurchase,GooglePlayConsole externalClass
<<<<<<< HEAD
    class UserLayer,Frontend,AuthRouter,AuthLayer,APILayer,Backend,AILayer,DataLayer,ExternalLayer layerClass
=======
    class UserLayer,Frontend,AuthRouter,AuthLayer,APILayer,Backend,AILayer,DataLayer,ExternalLayer layerClass
>>>>>>> f0780f1cf522000514032d53cc9ad9be80499ef6
